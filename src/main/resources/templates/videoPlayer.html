<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
<head>
    <meta charset="UTF-8">
    <title th:text="|ğŸˆğŸˆğŸˆ ${info.videoName}|">Title</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer@1.25.0/dist/DPlayer.min.css">
    <style>
        /**é‡ç½®æ ‡ç­¾é»˜è®¤æ ·å¼*/
        * {
            margin: 0;
            padding: 0;
            list-style: none;
            font-family: "Microsoft YaHei", Helvetica, "Meiryo UI", "Malgun Gothic", "Segoe UI", "Trebuchet MS", "Monaco", monospace, Tahoma, STXihei, "åæ–‡ç»†é»‘", STHeiti, "Helvetica Neue", "Droid Sans", "wenquanyi micro hei", FreeSans, Arimo, Arial, SimSun, "å®‹ä½“", Heiti, "é»‘ä½“", sans-serif;
        }
        #container {
            width: 307px;
            height: 530px;
            background: #eee;
            /*margin: 80px auto 0;*/
            position: relative;
        }
        .footer {
            width: 307px;
            height: 40px;
            position: absolute;
            bottom: 0;
            padding: 3px;
        }

        .footer input {
            width: 225px;
            height: 45px;
            outline: none;
            font-size: 3px;
            /*		text-indent: 10px;*/
            position: absolute;
            border-radius: 6px;
        }

        .footer button {
            float: right;
        }

        img {
            width: 60px;
            height: 60px;
        }

        .content {
            font-size: 10px;
            width: 307px;
            height: 460px;
            overflow: auto;
            padding: 5px;
        }

        .content li {
            /*margin-top: 5px;
            padding-left: 5px;*/
            width: 295px;
            display: block;
            clear: both;
            overflow: hidden;
        }

        .content li span {
            background: #7cfc00;
            padding: 10px;
            border-radius: 10px;
            float: left;
            margin: 6px 10px 0 10px;
            max-width: 310px;
            border: 1px solid #ccc;
            box-shadow: 0 0 3px #ccc;
        }
        .content li span.left {
            float: left;
            background: #fff;
        }
        .content li span.right {
            float: right;
            background: #7cfc00;
        }
    </style>
    <link rel="stylesheet" href="../static/layui/css/layui.css" th:href="@{/layui/css/layui.css}">

</head>
<body>
<!--å› ä¸ºiframeåŠ è½½æ…¢å¯èƒ½ä¼šå¯¼è‡´windows.onloadå‡ºç°ç¼“æ…¢åŠ è½½ï¼Œæ‰€ä»¥ä½¿ç”¨div-->
<!--UUIDæˆ¿é—´çš„å”¯ä¸€ID-->
<p id="UUID" th:text="${UUID}" STYLE="display: none">UUID</p>
<!--ç”¨æˆ·çš„IDå·ç ç”¨äºå‘é€æ¶ˆæ¯-->
<p id="id" th:text="${user.id}" STYLE="display: none">userId</p>
<!--å¥½å‹çš„IDå·ç ç”¨äºå‘é€æ¶ˆæ¯-->
<p id="anotherId" STYLE="display: none">0</p>
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
    <legend th:text="${info.videoName}">ç‰‡åï¼š8864</legend>
</fieldset>
<div class="layui-fluid">
    <div class="layui-row layui-col-space30">
        <div class="layui-col-md9">
            <div class="videoBox">
                <div id="dplayer"></div>
            </div>
        </div>
        <div class="layui-col-md3">
            <div style="height: 600px">
                <blockquote class="layui-elem-quote layui-quote-nm">
                    <span style="color:#c2c2c2">åœ¨çº¿ï¼š</span>
                    <span id="userInfo"></span>
                </blockquote>
                <!--èŠå¤©é¢æ¿container-->
                <div id="container">
                    <ul class="content">
                    </ul>
                    <!--åº•éƒ¨è¾“å…¥æ¡†ä»¥åŠå‘é€æ¡†-->
                    <div class="footer">
                        <input id="text" type="text" name="title" autocomplete="off" class="layui-input">
                        <button id="btn" onclick="start()" class="layui-btn layui-btn-lg">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>

<script src="../static/layui/layui.js" th:src="@{/layui/layui.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.2/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dplayer@1.25.0/dist/DPlayer.min.js"></script>
<script th:inline="javascript">
    var dp = new DPlayer({
        container: document.getElementById('dplayer'),
        video: {
            // url: "https://down--bucket.oss-cn-qingdao.aliyuncs.com/5941c88c73da48ad83de9b7ab959ab0f.mp4"
            url: [[${info.videoUrl}]]
        }
    });
    /**
     * è°ƒæ•´iframeçª—å£çš„å¤§å°
     * @type {HTMLElement}
     */
    document.getElementById("dplayer").style.height = document.getElementById("dplayer").scrollWidth * 0.65 + "px"
</script>
<!--å¤åˆ¶é“¾æ¥åœ°å€JS-->
<script type="text/javascript">
    /**
     * å¤åˆ¶å†…å®¹åˆ°ç²˜è´´æ¿
     * content : éœ€è¦å¤åˆ¶çš„å†…å®¹
     * message : å¤åˆ¶å®Œåçš„æç¤ºï¼Œä¸ä¼ åˆ™é»˜è®¤æç¤º"å¤åˆ¶æˆåŠŸ"
     */
    function copyToClip(content, message) {
        var aux = document.createElement("input");
        aux.setAttribute("value", content);
        document.body.appendChild(aux);
        aux.select();
        document.execCommand("copy");
        document.body.removeChild(aux);
        layer.msg('å¤åˆ¶æˆåŠŸï¼è¯·åˆ†äº«ç»™æ‚¨çš„å¥½å‹');
    }

    /**
     * æ¨¡æ€æ¡†å¤åˆ¶
     * @type {string}
     */
    var url = window.location.toString();
    layui.use('layer', function () {
        var layer = layui.layer;
        layer.open({
            title: 'å¦‚éœ€é‚€è¯·ï¼šè¯·ç‚¹å‡»å¤åˆ¶',
            content: url,
            btn: ['å¤åˆ¶','å–æ¶ˆ'],
            yes: function () {
                copyToClip(url)
            },
            cancel: function () {
                return true
            }
        });
    });
</script>
<!--åŒæ­¥è¿›åº¦çš„Websocket-->
<script type="text/javascript">
var syncVideoWebSocket = null;

</script>
<!--å‘é€æ¶ˆæ¯ä»¥åŠç”¨æˆ·ä¿¡æ¯çš„JS-->
<script type="text/javascript">
    <!--WebSocketè¿æ¥-->
    var syncVideoWebSocket = null;
    var userInfoWebSocket = null;
    var MessageWebSocket = null;
    var content = document.getElementsByTagName('ul')[0]; //è·å–æ–‡æœ¬æ¡†çš„å†…å®¹

    function userInfoOnOpen(event) {
        console.log("ç”¨æˆ·æœåŠ¡è¿æ¥æˆåŠŸ")
    }

    function userInfoOnMessage(event) {
        console.log("ç”¨æˆ·åŠ å…¥æˆ–è€…é€€å‡º")
        $('#userInfo').html("")
        console.log(event.data);
        var userInfoList = JSON.parse(event.data);//è§£æå½“å‰æˆ¿é—´ä¸­çš„ç”¨æˆ·List
        userInfoList.forEach(function (value,index) {
            $('#userInfo').append("   "+value.nickName)
            if (value.id!==$('#id').text()){
                $('#anotherId').text(value.id);
            }
        })
        if (userInfoList.length===1){//åªæœ‰ä¸€ä¸ªç”¨æˆ·æ—¶
            $('#anotherId').text("0");
        }
    }

    function userInfoOnError(event) {
        console.log("ç”¨æˆ·æœåŠ¡è¿æ¥å‘ç”Ÿé”™è¯¯")
    }

    function userInfoOnClose(event) {
        console.log("ç”¨æˆ·æœåŠ¡è¿æ¥å…³é—­")
    }

    function twoChatOnOpen(event) {
        console.log("èŠå¤©æœåŠ¡è¿æ¥æˆåŠŸ")
    }

    function twoChatOnMessage(event) {
        var content = document.getElementsByTagName('ul')[0]; //æ§åˆ¶å±å¹•æ»šåŠ¨
        console.log("èŠå¤©æœåŠ¡æ”¶åˆ°æ¶ˆæ¯")
        console.log(event.data);
        var message = JSON.parse(event.data);
        if (message.launchId == $('#id').text()){
            //è‡ªå·±ä¸ºæ¶ˆæ¯å‘é€æ–¹æ—¶ï¼Œæ ·å¼ä¸ºé å³
            content.innerHTML += '<li><span style="float: right;background: #fff;">' + message.content + '</span></li>';
        }else {
            //å¦‚æœè‡ªå·±ä¸æ˜¯æ¶ˆæ¯å‘é€æ–¹ï¼Œæ ·å¼ä¸ºé å·¦
            content.innerHTML += '<li><span style="float: left;background: #7cfc00;">' + message.content + '</span></li>';
        }
        content.scrollTop = content.scrollHeight;
    }

    function twoChatOnError(event) {
        console.log("èŠå¤©æœåŠ¡è¿æ¥å‘ç”Ÿé”™è¯¯")
    }

    function twoChatOnClose(event) {
        console.log("èŠå¤©æœåŠ¡è¿æ¥å…³é—­")
    }

    function syncVideoOnOpen(event) {
        console.log("è§†é¢‘åŒæ­¥æœåŠ¡å¼€å¯")
    }
    function syncVideoOnMessage(event) {
        console.log("è§†é¢‘åŒæ­¥æœåŠ¡æ”¶åˆ°æ¶ˆæ¯")
        console.log(event.data);
        var message = JSON.parse(event.data);
/*        if (message.state == 0){
            dp.pause()
            dp.seek(message.time)
        }else if(message.state == 1){
            dp.play()
            dp.seek(message.time)
        }else if(message.state == 2){
            dp.seek(message.time)
        }*/
        if (message.state == 0){
            if (dp.video.paused){
                dp.play();
                dp.seek(message.time)
            }else {
                dp.pause();
                dp.seek(message.time)
            }
        }else if(message.state == 2){
            dp.seek(message.time)
        }

    }
    function syncVideoOnError(event) {
        console.log("è§†é¢‘åŒæ­¥æœåŠ¡é”™è¯¯")

    }
    function syncVideoOnClose(event) {
        console.log("è§†é¢‘åŒæ­¥æœåŠ¡å…³é—­")

    }

    $(document).ready(
        function () {
            var homeId = $('#UUID').text();
            var userId = $('#id').text();
            var serverHot = window.location.host;
            userInfoWebSocket = new WebSocket('ws://' + serverHot + '/userInfoTransfer/' + homeId + '/' + userId);

            userInfoWebSocket.onopen = function (event) {
                userInfoOnOpen(event);
            };
            userInfoWebSocket.onmessage = function (event) {
                userInfoOnMessage(event);
            };
            userInfoWebSocket.onerror = function (event) {
                userInfoOnError(event);
            };
            userInfoWebSocket.onclose = function (event) {
                userInfoOnClose(event);
            };

            //----------------------------jsäº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œåˆ›å»ºä¸€ä¸ªæ–°è¿æ¥---------------------------

            MessageWebSocket = new WebSocket('ws://' + serverHot + '/twoChat/' + homeId);

            MessageWebSocket.onopen = function (event) {
                twoChatOnOpen(event);
            }
            MessageWebSocket.onmessage = function (ev) {
                twoChatOnMessage(ev);
            }
            MessageWebSocket.onerror = function (ev) {
                twoChatOnError(ev);
            }
            MessageWebSocket.onclose = function (ev) {
                twoChatOnClose(ev);
            }

            //--------------------------------åˆ›å»ºè§†é¢‘è¿æ¥-----------------------------------------

            syncVideoWebSocket = new WebSocket('ws://' + serverHot + '/syncVideo/' + homeId);

            syncVideoWebSocket.onopen = function (event) {
                syncVideoOnOpen(event);
            }
            syncVideoWebSocket.onmessage = function (event) {
                syncVideoOnMessage(event);
            }
            syncVideoWebSocket.onclose = function (event) {
                syncVideoOnClose(event);
            }
            syncVideoWebSocket.onerror = function (event) {
                syncVideoOnError(event);
            }
        }
    )

    /*å‘é€æ¶ˆæ¯çš„é€»è¾‘*/
    function start() {
        var userId = $('#id').text();
        var anotherUserId = $('#anotherId').text();
        var content = document.getElementsByTagName('ul')[0]; //æ§åˆ¶å±å¹•æ»šåŠ¨
        var text = document.getElementById('text'); //è·å–è¾“å…¥å†…å®¹
        if (text.value === '') {
            console.log("è¾“å…¥ä¿¡æ¯ä¸ºç©º")
        } else {
            var message = {
                launchId: userId,
                receiveId: anotherUserId,//ç”¨æˆ·æäº¤receiveId,é»˜è®¤ä¸º0ï¼Œä»£è¡¨åªæœ‰ä¸€ä¸ªäººæ¥èŠå¤©ã€‚
                content: text.value
            }
            MessageWebSocket.send(JSON.stringify(message));
            text.value = '';//é‡ç½®text.value
            content.scrollTop = content.scrollHeight;// å†…å®¹è¿‡å¤šæ—¶,å°†æ»šåŠ¨æ¡æ”¾ç½®åˆ°æœ€åº•ç«¯
            //å‘é€socketè¿æ¥ä¿¡æ¯
        }
    }

/*    //ç›‘å¬è§†é¢‘æš‚åœ
    dp.on('pause', function () {
        var videoMessage = {
            state: 0,//idä¸º0ä»£è¡¨ä¸ºæ’­æ”¾å™¨æš‚åœè¯·æ±‚
            time: Math.round(dp.video.currentTime)
        }
        syncVideoWebSocket.send(JSON.stringify(videoMessage))
        //console.log("ç‚¹å‡»æš‚åœæŒ‰é’®")
    });
    //ç›‘å¬è§†é¢‘æ’­æ”¾
    dp.on('play', function () {
        var videoMessage = {
            state : 1,//idä¸º1ä»£è¡¨ä¸ºæ’­æ”¾å™¨æ’­æ”¾è¯·æ±‚
            time : Math.round(dp.video.currentTime)
        }
        syncVideoWebSocket.send(JSON.stringify(videoMessage))
        //console.log("ç‚¹å‡»æ’­æ”¾æŒ‰é’®")
    });*/
    //ç›‘å¬è§†é¢‘æš‚åœ
    $(".dplayer-video-wrap").click(function (){
        var videoMessage = {
            state : 0,//idä¸º0ä»£è¡¨æ›´æ–°çŠ¶æ€
            time : dp.video.currentTime
        }
        syncVideoWebSocket.send(JSON.stringify(videoMessage))
    });

    //ç›‘å¬è¿›åº¦æ¡æ‹‰åŠ¨
    $(".dplayer-bar-wrap").click(function () {
        var videoMessage = {
            state: 2,//idä¸º0ä»£è¡¨æ‹‰åŠ¨è¿›åº¦è¯·æ±‚
            time: dp.video.currentTime
        }
        syncVideoWebSocket.send(JSON.stringify(videoMessage))
        //console.log(Math.round(dp.video.currentTime))
    });
</script>
<!--ç›‘æ§enterå‘é€æ¶ˆæ¯çš„JS-->
<script>
    // ç›‘æ§enteré”®ï¼šå‘é€ä¿¡æ¯
    $(document).keyup(function (e) {
        var key = e.which;
        if (key === 13) {
            start();
        }
    });
</script>
</html>